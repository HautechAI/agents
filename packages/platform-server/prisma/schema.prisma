// Prisma schema for platform-server per issue #376

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Conversation {
  id         String   @id @default(cuid())
  nodeId     String
  status     ConversationStatus
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  runs       Run[]
  snapshots  ConversationSnapshot[]

  @@index([nodeId, updatedAt])
}

model Run {
  id             String   @id @default(cuid())
  conversation   Conversation @relation(fields: [conversationId], references: [id])
  conversationId String
  nodeId         String
  status         RunStatus
  startedAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  expiresAt      DateTime?

  @@index([nodeId, status, updatedAt])
  @@index([conversationId, startedAt])
  @@index([expiresAt])
}

model ConversationSnapshot {
  id             String   @id @default(cuid())
  conversation   Conversation @relation(fields: [conversationId], references: [id])
  conversationId String
  nodeId         String
  version        Int      @default(0)
  summaryText    String?
  stateJson      Json
  updatedAt      DateTime @updatedAt

  @@unique([nodeId, conversationId])
  @@index([updatedAt])
}

model NodeState {
  nodeId    String   @id
  state     Json
  updatedAt DateTime @updatedAt
}

enum ConversationStatus {
  active
  archived
}

enum RunStatus {
  created
  running
  succeeded
  failed
  canceled
}

// Removed Message/ToolCall persistence in favor of snapshot-only model
